<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APStat Chain - MVP</title>
    
    <!-- Day 2.5: Embedded Libraries -->
    <!-- Instruction: Paste the minified Chart.js v3.9.1+ code here -->
    <script>/* CHART.JS LIBRARY CODE GOES HERE */</script>
    <!-- Instruction: Paste the Chart.js DataLabels plugin v2 code here -->
    <script>/* CHART.JS DATALABELS PLUGIN CODE GOES HERE */</script>
    <!-- Instruction: Paste the MathJax v3 code here -->
    <script>/* MATHJAX LIBRARY CODE GOES HERE */</script>

    <style>
        /* --- STYLES (Expanded for Day 2.5) --- */
        :root {
            --bg-color: #f4f4f4; --text-color: #333; --container-bg: #fff; --primary-color: #005a9c;
            --button-bg: #007bff; --button-hover-bg: #0056b3; --border-color: #ddd; --header-bg: #f2f2f2;
            --choice-bg: #f8f9fa; --choice-hover-bg: #e9ecef; --choice-border: #e9ecef;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 800px; margin: auto; background: var(--container-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: var(--primary-color); }
        button { background: var(--button-bg); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px 0; }
        button:hover { background: var(--button-hover-bg); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .hidden { display: none; }
        #identity-screen .mnemonic { background: #e9ecef; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 1.2em; text-align: center; margin: 20px 0; }
        #app-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        #question-container { border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .question-prompt { font-size: 1.2em; margin-bottom: 15px; }
        .question-meta { font-size: 0.8em; color: #777; margin-bottom: 20px; }
        .choices-container label { display: block; background: var(--choice-bg); border: 1px solid var(--choice-border); border-radius: 5px; padding: 10px; margin-bottom: 10px; cursor: pointer; }
        .choices-container label:hover { background: var(--choice-hover-bg); }
        .choices-container input { margin-right: 10px; }
        .question-image { max-width: 100%; height: auto; border-radius: 5px; margin: 10px 0; }
        .nav-buttons { text-align: center; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }
        th { background-color: var(--header-bg); }
        .chart-container { position: relative; width: 90%; max-width: 600px; margin: 20px auto; }

        /* --- Dark Mode Styles --- */
        body.dark-theme {
            --bg-color: #1a1a1a; --text-color: #e0e0e0; --container-bg: #2d2d2d; --primary-color: #5BC0EB;
            --button-bg: #5BC0EB; --button-hover-bg: #87ceeb; --border-color: #555; --header-bg: #404040;
            --choice-bg: #333; --choice-hover-bg: #444; --choice-border: #555;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Screen 1: Identity Creation -->
        <div id="identity-screen">
            <h1>Welcome to APStat Chain</h1>
            <p>To begin, we need to generate your unique, decentralized identity. This 4-word phrase is your private key. Keep it secret, keep it safe!</p>
            <div id="mnemonic-display" class="mnemonic"></div>
            <button id="generate-mnemonic-btn">Generate New Identity</button>
            <button id="confirm-identity-btn" class="hidden">Confirm and Start Learning</button>
        </div>

        <!-- Screen 2: Main Application -->
        <div id="app-container" class="hidden">
            <div id="app-header">
                <h2>APStat Chain</h2>
                <div id="user-info" style="text-align: right; font-size: 0.8em;"></div>
                <div>
                    <button id="theme-toggle-btn">ðŸŒ™</button>
                    <button id="sync-btn">Sync</button>
                </div>
            </div>
            
            <div id="main-content">
                <div id="question-renderer">
                    <div id="question-container"></div>
                    <div class="nav-buttons">
                        <button id="prev-btn">Previous</button>
                        <button id="next-btn">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Island (Embedded Data) -->
    <script>
        // INSTRUCTION: PASTE THE POK_WORDLIST ARRAY CONTENT HERE
        const POK_WORDLIST = [/* ... PASTE HERE ... */];
        
        // INSTRUCTION: PASTE THE POK_CURRICULUM JSON OBJECT CONTENT HERE
        const POK_CURRICULUM = {/* ... PASTE HERE ... */};
    </script>

    <!-- Main Application Logic Script -->
    <script type="module">
        // Register Chart.js datalabels plugin globally
        if (window.ChartDataLabels) {
            Chart.register(window.ChartDataLabels);
        }

        const APStatChain = {
            state: {
                wordlist: [], curriculum: null, flatCurriculum: [],
                identity: null,
                userState: { currentIndex: 0, progress: {} },
                chain: [], mempool: [], peers: {},
                theme: 'light',
            },
            chartInstances: {},

            // --- DAY 1: IDENTITY & CRYPTO MODULE ---
            crypto: {
                generateMnemonic: function(wordlist) {
                    const mnemonic = [];
                    const usedIndices = new Set();
                    while (mnemonic.length < 4) {
                        const idx = Math.floor(Math.random() * wordlist.length);
                        if (!usedIndices.has(idx)) {
                            usedIndices.add(idx);
                            mnemonic.push(wordlist[idx]);
                        }
                    }
                    return mnemonic.join(' ');
                },
                deriveKeyPair: async function(mnemonic) {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(mnemonic);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    return {
                        mnemonic,
                        privateKey: hashHex,
                        publicKey: hashHex.slice(0, 32) // Truncated for display and identification
                    };
                }
            },

            // --- DATA LOADING (Modified for embedded data) ---
            data: {
                loadData: function() {
                    APStatChain.state.wordlist = POK_WORDLIST;
                    APStatChain.state.curriculum = POK_CURRICULUM;
                    console.log(`Successfully loaded ${APStatChain.state.wordlist.length} words and ${Object.keys(APStatChain.state.curriculum).length} lessons from embedded variables.`);
                }
            },
            
            // --- DAY 2: QUESTION RENDERER MODULE ---
            renderer: {
                flattenCurriculum: function() {
                    const flat = [];
                    const curriculum = APStatChain.state.curriculum;
                    for (const lessonKey in curriculum) {
                        curriculum[lessonKey].forEach(question => {
                            flat.push({ ...question, lessonKey });
                        });
                    }
                    APStatChain.state.flatCurriculum = flat;
                    console.log(`Curriculum flattened into ${flat.length} total questions.`);
                },
                _renderImage: function(attachment) {
                    if (!attachment || !attachment.imageBase64) return '';
                    const alt = attachment.imageAlt || 'Question related image';
                    const caption = attachment.imageCaption || '';
                    return `
                        <div>
                            <img src="${attachment.imageBase64}" alt="${alt}" class="question-image">
                            ${caption ? `<p><em>${caption}</em></p>` : ''}
                        </div>
                    `;
                },
                _renderTable: function(tableData) {
                    if (!tableData || tableData.length === 0) return '';
                    let tableHTML = '<table>';
                    tableHTML += '<thead><tr>';
                    tableData[0].forEach(header => tableHTML += `<th>${header}</th>`);
                    tableHTML += '</tr></thead>';
                    tableHTML += '<tbody>';
                    tableData.slice(1).forEach(row => {
                        tableHTML += '<tr>';
                        row.forEach(cell => tableHTML += `<td>${cell}</td>`);
                        tableHTML += '</tr>';
                    });
                    tableHTML += '</tbody></table>';
                    return tableHTML;
                },
                _renderVideo: function(videoUrl) {
                    if (!videoUrl) return '';
                    return `<p><a href="${videoUrl}" target="_blank" rel="noopener noreferrer">Play Lesson Video</a></p>`;
                },
                _renderChart: function(attachment, questionId) {
                    const chartId = `chart-${questionId}`;
                    const container = document.createElement('div');
                    container.className = 'chart-container';
                    // Canvas must have explicit height for Chart.js
                    container.innerHTML = `<canvas id="${chartId}" height="400"></canvas>`;
                    
                    setTimeout(() => {
                        const ctx = document.getElementById(chartId)?.getContext('2d');
                        if (!ctx) return;

                        // Destroy previous chart instance if it exists
                        if (APStatChain.chartInstances[chartId]) {
                            APStatChain.chartInstances[chartId].destroy();
                        }

                        const chartConfig = this._getChartConfig(attachment);
                        APStatChain.chartInstances[chartId] = new Chart(ctx, chartConfig);
                    }, 0); // Allow DOM to update before creating chart

                    return container.outerHTML;
                },
                _getChartConfig: function(attachment) {
                    // Helper to build Chart.js config, including theme-aware colors
                    const isDark = APStatChain.state.theme === 'dark';
                    const textColor = isDark ? '#e0e0e0' : '#333';
                    const gridColor = isDark ? '#555' : '#e0e0e0';

                    const baseOptions = {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: textColor } },
                            datalabels: {
                                color: textColor,
                                anchor: 'end',
                                align: 'top',
                            }
                        },
                        scales: {
                            x: { ticks: { color: textColor }, grid: { color: gridColor }, title: { color: textColor, display: true, text: attachment.chartConfig?.xAxis?.title || '' } },
                            y: { ticks: { color: textColor }, grid: { color: gridColor }, title: { color: textColor, display: true, text: attachment.chartConfig?.yAxis?.title || '' } }
                        }
                    };

                    // Specific chart type configurations would go here
                    // This is a simplified example for a bar chart
                    return {
                        type: attachment.chartType || 'bar',
                        data: {
                            labels: attachment.xLabels,
                            datasets: attachment.series.map((s, i) => ({
                                label: s.name,
                                data: s.values,
                                backgroundColor: isDark ? `hsla(${i*60}, 100%, 70%, 0.7)` : `hsla(${i*60}, 100%, 50%, 0.7)`,
                            })),
                        },
                        options: baseOptions,
                    };
                },

                renderCurrentQuestion: function() {
                    const state = APStatChain.state;
                    const userState = APStatChain.state.userState;
                    const question = state.flatCurriculum[userState.currentIndex];
                    const container = document.getElementById('question-container');

                    console.log("Rendering question at index " + userState.currentIndex + ": " + (question ? question.prompt : 'No question data'));

                    if (!question) { 
                        container.innerHTML = `<p>Error: Question not found at index ${userState.currentIndex}.</p>`;
                        return;
                    }

                    let contentHTML = `
                        <div class="question-meta">
                            Question ${userState.currentIndex + 1} of ${state.flatCurriculum.length} | ID: ${question.id} | From: ${question.lessonKey}
                        </div>
                        <div class="question-prompt">${question.prompt}</div>
                    `;

                    if (question.attachments) {
                        if (question.attachments.imageBase64) contentHTML += this._renderImage(question.attachments);
                        if (question.attachments.table) contentHTML += this._renderTable(question.attachments.table);
                        // Day 2.5: Handle charts
                        if (question.attachments.chartType) contentHTML += this._renderChart(question.attachments, question.id);
                    }
                    if (question.videoUrl) contentHTML += this._renderVideo(question.videoUrl); // Day 2.5: Handle Video
                    
                    const choices = question.choices || (question.attachments && question.attachments.choices);
                    if (question.type === 'multiple-choice' && choices) {
                        contentHTML += '<div class="choices-container">';
                        choices.forEach((choice, index) => {
                            const key = choice.key || String.fromCharCode(65 + index); // Fallback to A, B, C...
                            const value = choice.value || choice; // Handle if choices are strings
                            contentHTML += `
                                <label>
                                    <input type="radio" name="choice" value="${key}">
                                    <strong>${key}.</strong> ${value}
                                </label>
                            `;
                        });
                        contentHTML += '</div>';
                        contentHTML += `<button id="submit-answer-btn">Submit Answer</button>`;
                    }

                    container.innerHTML = contentHTML;
                    
                    // Day 2.5: Call MathJax to render any LaTeX
                    if (window.MathJax && window.MathJax.typeset) {
                        window.MathJax.typeset([container]);
                    }
                    
                    document.getElementById('prev-btn').disabled = (userState.currentIndex === 0);
                    // Day 2.5 Fix: Disable next button until answer is submitted
                    const isAnswered = !!userState.progress[question.id];
                    document.getElementById('next-btn').disabled = !isAnswered || (userState.currentIndex >= state.flatCurriculum.length - 1);
                }
            },
            
            // --- STATE MANAGEMENT MODULE ---
            storage: {
                saveState: function() {
                    try {
                        const stateToSave = {
                            identity: APStatChain.state.identity,
                            userState: APStatChain.state.userState,
                            chain: APStatChain.state.chain,
                            mempool: APStatChain.state.mempool,
                            peers: APStatChain.state.peers
                        };
                        localStorage.setItem('APStatChainState', JSON.stringify(stateToSave));
                        console.log("Application state saved.");
                    } catch (error) { console.error("Failed to save state:", error); }
                },
                loadState: function() {
                    try {
                        const savedState = localStorage.getItem('APStatChainState');
                        if (savedState) {
                            const parsed = JSON.parse(savedState);
                            APStatChain.state.identity = parsed.identity;
                            APStatChain.state.userState = parsed.userState || { currentIndex: 0, progress: {} };
                            APStatChain.state.chain = parsed.chain || [];
                            APStatChain.state.mempool = parsed.mempool || [];
                            APStatChain.state.peers = parsed.peers || {};
                            console.log("Application state loaded from localStorage.");
                            return true;
                        }
                        return false;
                    } catch (error) {
                        console.error("Failed to load state:", error);
                        localStorage.removeItem('APStatChainState');
                        return false;
                    }
                }
            },

            // --- UI Module ---
            ui: {
                showApp: function() {
                    document.getElementById('identity-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    const publicKey = APStatChain.state.identity.publicKey;
                    document.getElementById('user-info').innerText = `ID: ${publicKey.substring(0, 10)}...`;
                    console.log("Navigated to main app view.");
                },
                showIdentityScreen: function() {
                    document.getElementById('identity-screen').classList.remove('hidden');
                    document.getElementById('app-container').classList.add('hidden');
                    console.log("Navigated to identity screen.");
                },
                displayMnemonic: function(mnemonic) {
                    document.getElementById('mnemonic-display').textContent = mnemonic;
                    document.getElementById('confirm-identity-btn').classList.remove('hidden');
                },
                bindNavEvents: function() {
                    document.getElementById('prev-btn').addEventListener('click', () => {
                        if (APStatChain.state.userState.currentIndex > 0) {
                            APStatChain.state.userState.currentIndex--;
                            APStatChain.storage.saveState();
                            APStatChain.renderer.renderCurrentQuestion();
                        }
                    });
                    document.getElementById('next-btn').addEventListener('click', () => {
                        if (APStatChain.state.userState.currentIndex < APStatChain.state.flatCurriculum.length - 1) {
                            APStatChain.state.userState.currentIndex++;
                            APStatChain.storage.saveState();
                            APStatChain.renderer.renderCurrentQuestion();
                        }
                    });
                },
                
                // Day 2.5: Theme logic
                initTheme: function() {
                    const savedTheme = localStorage.getItem('APStatChainTheme') || 'light';
                    APStatChain.state.theme = savedTheme;
                    if (savedTheme === 'dark') {
                        document.body.classList.add('dark-theme');
                    }
                    document.getElementById('theme-toggle-btn').textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
                },
                toggleTheme: function() {
                    const newTheme = APStatChain.state.theme === 'light' ? 'dark' : 'light';
                    APStatChain.state.theme = newTheme;
                    localStorage.setItem('APStatChainTheme', newTheme);
                    if (newTheme === 'dark') {
                        document.body.classList.add('dark-theme');
                    } else {
                        document.body.classList.remove('dark-theme');
                    }
                    document.getElementById('theme-toggle-btn').textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
                    
                    // Re-render the current question to apply theme to charts
                    APStatChain.renderer.renderCurrentQuestion();
                }
            },

            // --- INITIALIZATION (Day 2.5 Refined) ---
            init: function() {
                console.log("APStat Chain Initializing...");
                this.data.loadData();
                this.renderer.flattenCurriculum();
                this.ui.initTheme(); // Set theme before rendering

                const stateExists = this.storage.loadState();

                if (stateExists && this.state.identity) {
                    // Day 2.5 Bug Fix: Validate currentIndex before use
                    if (this.state.userState.currentIndex >= this.state.flatCurriculum.length || this.state.userState.currentIndex < 0) {
                        this.state.userState.currentIndex = 0;
                    }
                    this.ui.showApp();
                    this.renderer.renderCurrentQuestion();
                    this.ui.bindNavEvents();
                    document.getElementById('theme-toggle-btn').addEventListener('click', this.ui.toggleTheme);
                } else {
                    this.ui.showIdentityScreen();
                    document.getElementById('generate-mnemonic-btn').addEventListener('click', () => {
                        const newMnemonic = this.crypto.generateMnemonic(this.state.wordlist);
                        this.ui.displayMnemonic(newMnemonic);
                    });
                    document.getElementById('confirm-identity-btn').addEventListener('click', async () => {
                        const mnemonic = document.getElementById('mnemonic-display').textContent;
                        if (mnemonic) {
                            this.state.identity = await this.crypto.deriveKeyPair(mnemonic);
                            console.log("New identity created:", this.state.identity);
                            this.storage.saveState();
                            this.ui.showApp();
                            this.renderer.renderCurrentQuestion();
                            this.ui.bindNavEvents();
                            document.getElementById('theme-toggle-btn').addEventListener('click', this.ui.toggleTheme);
                        }
                    });
                }
            }
        };

        // Start the application
        APStatChain.init();
    </script>

</body>
</html>