<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APStat Chain - MVP</title>
    
    <!-- Day 2.5: Embedded Libraries -->
    <!-- Instruction: Paste the minified Chart.js v3.9.1+ code here -->
    <script>/* CHART.JS LIBRARY CODE GOES HERE */</script>
    <!-- Instruction: Paste the Chart.js DataLabels plugin v2 code here -->
    <script>/* CHART.JS DATALABELS PLUGIN CODE GOES HERE */</script>
    <!-- Instruction: Paste the MathJax v3 code here -->
    <script>/* MATHJAX LIBRARY CODE GOES HERE */</script>

    <style>
        /* --- STYLES (No changes from Day 2.5) --- */
        :root {
            --bg-color: #f4f4f4; --text-color: #333; --container-bg: #fff; --primary-color: #005a9c;
            --button-bg: #007bff; --button-hover-bg: #0056b3; --border-color: #ddd; --header-bg: #f2f2f2;
            --choice-bg: #f8f9fa; --choice-hover-bg: #e9ecef; --choice-border: #e9ecef;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 800px; margin: auto; background: var(--container-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: var(--primary-color); }
        button { background: var(--button-bg); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px 0; }
        button:hover { background: var(--button-hover-bg); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .hidden { display: none; }
        #identity-screen .mnemonic { background: #e9ecef; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 1.2em; text-align: center; margin: 20px 0; }
        #app-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        #question-container { border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .question-prompt { font-size: 1.2em; margin-bottom: 15px; }
        .question-meta { font-size: 0.8em; color: #777; margin-bottom: 20px; }
        .choices-container label { display: block; background: var(--choice-bg); border: 1px solid var(--choice-border); border-radius: 5px; padding: 10px; margin-bottom: 10px; cursor: pointer; }
        .choices-container label:hover { background: var(--choice-hover-bg); }
        .choices-container input { margin-right: 10px; }
        .question-image { max-width: 100%; height: auto; border-radius: 5px; margin: 10px 0; }
        .nav-buttons { text-align: center; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }
        th { background-color: var(--header-bg); }
        .chart-container { position: relative; width: 90%; max-width: 600px; margin: 20px auto; }
        .answered-feedback { color: green; font-weight: bold; margin-top: 15px; }

        /* --- Dark Mode Styles --- */
        body.dark-theme {
            --bg-color: #1a1a1a; --text-color: #e0e0e0; --container-bg: #2d2d2d; --primary-color: #5BC0EB;
            --button-bg: #5BC0EB; --button-hover-bg: #87ceeb; --border-color: #555; --header-bg: #404040;
            --choice-bg: #333; --choice-hover-bg: #444; --choice-border: #555;
        }
        .dark-theme .answered-feedback { color: #81c784; }
    </style>
</head>
<body>
    <div class="container">
        <div id="identity-screen">
            <h1>Welcome to APStat Chain</h1>
            <p>To begin, we need to generate your unique, decentralized identity. This 4-word phrase is your private key. Keep it secret, keep it safe!</p>
            <div id="mnemonic-display" class="mnemonic"></div>
            <button id="generate-mnemonic-btn">Generate New Identity</button>
            <button id="confirm-identity-btn" class="hidden">Confirm and Start Learning</button>
        </div>
        <div id="app-container" class="hidden">
            <div id="app-header">
                <h2>APStat Chain</h2>
                <div id="user-info" style="text-align: right; font-size: 0.8em;"></div>
                <div>
                    <button id="theme-toggle-btn">ðŸŒ™</button>
                    <button id="sync-btn">Sync</button>
                </div>
            </div>
            <div id="main-content">
                <div id="question-renderer">
                    <div id="question-container"></div>
                    <div class="nav-buttons">
                        <button id="prev-btn">Previous</button>
                        <button id="next-btn">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Island (Embedded Data) - MUST be before the main script -->
    <script>
        // INSTRUCTION: PASTE THE POK_WORDLIST ARRAY CONTENT HERE
        const POK_WORDLIST = [/* ... PASTE WORDLIST HERE ... */];
        
        // INSTRUCTION: PASTE THE POK_CURRICULUM JSON OBJECT CONTENT HERE
        const POK_CURRICULUM = {/* ... PASTE CURRICULUM HERE ... */};
    </script>

    <!-- Main Application Logic Script -->
    <script type="module">
        if (window.ChartDataLabels) { Chart.register(window.ChartDataLabels); }

        const APStatChain = {
            state: {
                wordlist: [], curriculum: null, flatCurriculum: [],
                identity: null,
                userState: { currentIndex: 0, progress: {} },
                chain: [], mempool: [], peers: {},
                theme: 'light',
            },
            chartInstances: {},

            crypto: {
                generateMnemonic: function(wordlist) {
                    const mnemonic = [];
                    const usedIndices = new Set();
                    while (mnemonic.length < 4) {
                        const idx = Math.floor(Math.random() * wordlist.length);
                        if (!usedIndices.has(idx)) {
                            usedIndices.add(idx);
                            mnemonic.push(wordlist[idx]);
                        }
                    }
                    return mnemonic.join(' ');
                },
                deriveKeyPair: async function(mnemonic) {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(mnemonic);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    return {
                        mnemonic,
                        privateKey: hashHex,
                        publicKey: hashHex.slice(0, 32)
                    };
                },
                sign: async function(privateKey, message) {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(privateKey + message);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                }
            },

            data: {
                loadData: function() {
                    this.state.wordlist = POK_WORDLIST;
                    this.state.curriculum = POK_CURRICULUM;
                    console.log(`Successfully loaded ${this.state.wordlist.length} words and ${Object.keys(this.state.curriculum).length} lessons.`);
                }.bind(this) // Bind 'this' to APStatChain
            },
            
            renderer: {
                flattenCurriculum: function() {
                    const flat = [];
                    for (const lessonKey in APStatChain.state.curriculum) {
                        APStatChain.state.curriculum[lessonKey].forEach(question => {
                            flat.push({ ...question, lessonKey });
                        });
                    }
                    APStatChain.state.flatCurriculum = flat;
                    console.log(`Curriculum flattened into ${flat.length} total questions.`);
                },
                _renderImage: function(attachment) { /* ... same as 2.5 ... */ return `...`; },
                _renderTable: function(tableData) { /* ... same as 2.5 ... */ return `...`; },
                _renderVideo: function(videoUrl) { /* ... same as 2.5 ... */ return `...`; },
                _renderChart: function(attachment, questionId) { /* ... same as 2.5 ... */ return `...`; },
                _getChartConfig: function(attachment) { /* ... same as 2.5 ... */ return {}; },

                renderCurrentQuestion: function() {
                    const state = APStatChain.state;
                    const userState = APStatChain.state.userState;
                    const question = state.flatCurriculum[userState.currentIndex];
                    const container = document.getElementById('question-container');

                    if (!question) { container.innerHTML = `<p>Error...</p>`; return; }

                    let contentHTML = `
                        <div class="question-meta">
                            Question ${userState.currentIndex + 1} of ${state.flatCurriculum.length} | ID: ${question.id} | From: ${question.lessonKey}
                        </div>
                        <div class="question-prompt">${question.prompt}</div>
                    `;

                    if (question.attachments) {
                        if(question.attachments.imageBase64) contentHTML += this._renderImage(question.attachments);
                        if(question.attachments.table) contentHTML += this._renderTable(question.attachments.table);
                        if(question.attachments.chartType) contentHTML += this._renderChart(question.attachments, question.id);
                    }
                    if (question.videoUrl) contentHTML += this._renderVideo(question.videoUrl);
                    
                    const choices = question.choices || (question.attachments && question.attachments.choices);
                    const isAnswered = !!userState.progress[question.id];

                    if (question.type === 'multiple-choice' && choices) {
                        contentHTML += '<div class="choices-container">';
                        choices.forEach(choice => {
                            const key = choice.key || '';
                            const value = choice.value || '';
                            const checked = isAnswered && userState.progress[question.id].answer === key ? 'checked' : '';
                            const disabled = isAnswered ? 'disabled' : '';
                            contentHTML += `<label><input type="radio" name="choice" value="${key}" ${checked} ${disabled}><strong>${key}.</strong> ${value}</label>`;
                        });
                        contentHTML += '</div>';
                        
                        if (isAnswered) {
                            contentHTML += `<div class="answered-feedback">Answer Submitted.</div>`;
                        } else {
                            contentHTML += `<button id="submit-answer-btn">Submit Answer</button>`;
                        }
                    }

                    container.innerHTML = contentHTML;

                    const submitBtn = document.getElementById('submit-answer-btn');
                    if (submitBtn) {
                        submitBtn.addEventListener('click', () => APStatChain.mempool.createTransaction());
                    }
                    
                    if (window.MathJax && window.MathJax.typeset) { window.MathJax.typeset([container]); }

                    document.getElementById('prev-btn').disabled = (userState.currentIndex === 0);
                    document.getElementById('next-btn').disabled = !isAnswered || (userState.currentIndex >= state.flatCurriculum.length - 1);
                }
            },

            mempool: {
                createTransaction: async function() {
                    const state = APStatChain.state;
                    const userState = APStatChain.state.userState;
                    const currentQuestion = state.flatCurriculum[userState.currentIndex];
                    const questionId = currentQuestion.id;

                    if (state.mempool.some(tx => tx.questionId === questionId)) return;

                    const selectedChoice = document.querySelector('input[name="choice"]:checked');
                    if (!selectedChoice) { alert("Please select an answer."); return; }
                    const userAnswer = selectedChoice.value;
                    
                    const timestamp = Date.now();
                    const messageToSign = `${questionId}${userAnswer}${timestamp}`;
                    const signature = await APStatChain.crypto.sign(state.identity.privateKey, messageToSign);

                    const transaction = { questionId, userAnswer, timestamp, signature };

                    state.mempool.push(transaction);
                    userState.progress[questionId] = { answered: true, answer: userAnswer };
                    
                    console.log("Transaction created:", transaction);
                    
                    APStatChain.storage.saveState();
                    APStatChain.renderer.renderCurrentQuestion();
                }
            },
            
            storage: { /* ... (Grok's robust version) ... */ },
            ui: { /* ... (Grok's robust version) ... */ },
            
            init: function() {
                console.log("APStat Chain Initializing...");
                this.data.loadData();
                this.renderer.flattenCurriculum();
                this.ui.initTheme();

                const stateExists = this.storage.loadState();

                if (stateExists && this.state.identity) {
                    if (!this.state.userState || this.state.userState.currentIndex === undefined || this.state.userState.currentIndex >= this.state.flatCurriculum.length || this.state.userState.currentIndex < 0) {
                        this.state.userState = { currentIndex: 0, progress: {} };
                    }
                    this.ui.showApp();
                    this.renderer.renderCurrentQuestion();
                    this.ui.bindNavEvents();
                    document.getElementById('theme-toggle-btn').addEventListener('click', () => this.ui.toggleTheme());
                } else {
                    this.ui.showIdentityScreen();
                    document.getElementById('generate-mnemonic-btn').addEventListener('click', () => {
                        const newMnemonic = this.crypto.generateMnemonic(this.state.wordlist);
                        this.ui.displayMnemonic(newMnemonic);
                    });
                    document.getElementById('confirm-identity-btn').addEventListener('click', async () => {
                        const mnemonic = document.getElementById('mnemonic-display').textContent;
                        if (mnemonic) {
                            this.state.identity = await this.crypto.deriveKeyPair(mnemonic);
                            this.storage.saveState();
                            this.ui.showApp();
                            this.renderer.renderCurrentQuestion();
                            this.ui.bindNavEvents();
                            document.getElementById('theme-toggle-btn').addEventListener('click', () => this.ui.toggleTheme());
                        }
                    });
                }
            }
        };

        // Bind 'this' context for methods called from event listeners or other scopes
        APStatChain.ui.toggleTheme = APStatChain.ui.toggleTheme.bind(APStatChain);
        
        APStatChain.init();
    </script>
</body>
</html>