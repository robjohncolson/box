<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive AP Stats Quiz Renderer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }
        .json-input {
            width: 100%;
            height: 200px;
            font-family: monospace;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            resize: vertical;
            box-sizing: border-box;
        }
        .load-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s ease;
            margin: 5px;
        }
        .load-button:hover {
            background: #218838;
        }
        .clear-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s ease;
            margin: 5px;
        }
        .clear-button:hover {
            background: #545b62;
        }
        .file-input {
            margin-bottom: 15px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        .quiz-container {
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .question-header {
            background: #3498db;
            color: white;
            padding: 10px 15px;
            margin: -25px -25px 20px -25px;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
            font-size: 18px;
        }
        .question-id {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .question-prompt {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #2c3e50;
        }
        .table-container {
            margin: 15px 0;
            overflow-x: auto;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            background: #f8f9fa;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px 15px;
            text-align: left;
        }
        th {
            background-color: #343a40;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .chart-container {
            margin: 20px 0;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 2px solid #e9ecef;
        }
        .chart-title {
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: #495057;
        }
        .chart-canvas {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .choices {
            margin-top: 15px;
        }
        .choice {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 8px 0;
            transition: all 0.3s ease;
        }
        .choice:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        .choice-key {
            font-weight: bold;
            display: inline-block;
            width: 30px;
            color: #495057;
        }
        .answer-key {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-weight: bold;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        .success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        .stats {
            background: #e7f3ff;
            border: 2px solid #0066cc;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        /* Dark mode adaptations */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
                color: #e0e0e0;
            }
            
            .container {
                background: #2d2d2d;
                color: #e0e0e0;
            }
            
            .upload-section {
                background: #333333;
                border-color: #555555;
                color: #e0e0e0;
            }
            
            .quiz-container {
                background: #2d2d2d;
                border-color: #5BC0EB;
                color: #e0e0e0;
            }
            
            .question-header {
                background: #5BC0EB;
                color: #1a1a1a;
            }
            
            .chart-container {
                background: #2d2d2d;
                border-color: #555555;
            }
            
            .choice {
                background: #333333;
                border-color: #555555;
                color: #e0e0e0;
            }
            
            .choice:hover {
                background: #404040;
                border-color: #5BC0EB;
            }
            
            .answer-key {
                background: #2d4a2d;
                border-color: #4a7c59;
                color: #90ee90;
            }
            
            .stats {
                background: #1a2332;
                border-color: #5BC0EB;
                color: #e0e0e0;
            }
            
            .json-input {
                background: #333333;
                border-color: #555555;
                color: #e0e0e0;
            }
            
            .file-input {
                background: #333333;
                border-color: #555555;
                color: #e0e0e0;
            }
            
            table {
                background: #2d2d2d;
                color: #e0e0e0;
            }
            
            th {
                background-color: #404040;
                color: #e0e0e0;
            }
            
            tr:nth-child(even) {
                background-color: #333333;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßÆ Interactive AP Stats Quiz Renderer</h1>
        
        <div class="upload-section">
            <h3>üìÅ Load Quiz JSON File</h3>
            <input type="file" id="jsonFile" accept=".json" class="file-input">
            <button class="load-button" onclick="loadFromFile()">üìÇ Load from File</button>
            
            <div style="margin: 20px 0; color: #666; font-weight: bold;">
                ‚Äî OR ‚Äî
            </div>
            
            <h3>üìù Paste JSON Data</h3>
            <textarea class="json-input" id="jsonInput" placeholder="Paste your JSON quiz data here..."></textarea>
            <button class="load-button" onclick="loadFromText()">üìã Load from Text</button>
            <button class="clear-button" onclick="clearAll()">üóëÔ∏è Clear All</button>
        </div>
        
        <div id="messageContainer"></div>
        <div id="statsContainer"></div>
        <div id="questionsContainer"></div>
    </div>

    <script>
        let chartInstances = [];

        function clearAll() {
            document.getElementById('messageContainer').innerHTML = '';
            document.getElementById('questionsContainer').innerHTML = '';
            document.getElementById('statsContainer').innerHTML = '';
            document.getElementById('jsonInput').value = '';
            document.getElementById('jsonFile').value = '';
            
            // Destroy existing charts
            chartInstances.forEach(chart => chart.destroy());
            chartInstances = [];
        }

        function showMessage(message, type = 'error') {
            const messageContainer = document.getElementById('messageContainer');
            const className = type === 'success' ? 'success' : 'error';
            messageContainer.innerHTML = `<div class="${className}"><strong>${type === 'success' ? 'Success' : 'Error'}:</strong> ${message}</div>`;
        }

        function showStats(questions) {
            const statsContainer = document.getElementById('statsContainer');
            const totalQuestions = questions.length;
            const mcQuestions = questions.filter(q => q.type === 'multiple-choice').length;
            const hasAnswers = questions.filter(q => q.answerKey).length;
            const hasCharts = questions.filter(q => q.attachments && q.attachments.chartType).length;
            const hasTables = questions.filter(q => q.attachments && q.attachments.table).length;
            const barCharts = questions.filter(q => q.attachments && q.attachments.chartType === 'bar').length;
            const pieCharts = questions.filter(q => q.attachments && q.attachments.chartType === 'pie').length;
            const scatterCharts = questions.filter(q => q.attachments && q.attachments.chartType === 'scatter').length;
            
            let chartBreakdown = '';
            if (hasCharts > 0) {
                const chartTypes = [];
                if (barCharts > 0) chartTypes.push(`üìä Bar: ${barCharts}`);
                if (pieCharts > 0) chartTypes.push(`ü•ß Pie: ${pieCharts}`);
                if (scatterCharts > 0) chartTypes.push(`üìà Scatter: ${scatterCharts}`);
                chartBreakdown = ` (${chartTypes.join(', ')})`;
            }
            
            statsContainer.innerHTML = `
                <div class="stats">
                    <strong>üìä Quiz Statistics:</strong><br>
                    Total Questions: ${totalQuestions} | 
                    Multiple Choice: ${mcQuestions} | 
                    With Answer Keys: ${hasAnswers}<br>
                    üìà Charts: ${hasCharts}${chartBreakdown} | üìã Tables: ${hasTables}
                </div>
            `;
        }

        function isDarkMode() {
            return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        }

        function generateChartColors(count) {
            const lightColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56'
            ];
            
            const darkColors = [
                '#FF8FA3', '#5BC0EB', '#FFE066', '#6BE6E6', 
                '#B366FF', '#FFB366', '#FF8FA3', '#E9EBEF',
                '#6BE6E6', '#FF8FA3', '#5BC0EB', '#FFE066'
            ];
            
            const colors = isDarkMode() ? darkColors : lightColors;
            return colors.slice(0, count);
        }

        function getGridColor() {
            return isDarkMode() ? '#555555' : '#e9ecef';
        }

        function getScatterPointColor() {
            return isDarkMode() ? '#5BC0EB' : '#36A2EB';
        }

        function renderChart(chartData, questionId) {
            const chartId = `chart-${questionId}`;
            const config = chartData.chartConfig || {};
            const chartTitle = config.description ? 
                `üìä ${chartData.chartType.toUpperCase()} CHART` : 
                `üìä ${chartData.chartType.toUpperCase()} CHART`;
            
            let chartHtml = `
                <div class="chart-container">
                    <div class="chart-title">${chartTitle}</div>
                    ${config.description ? `<div style="font-size: 0.9em; color: #666; text-align: center; margin-bottom: 10px; font-style: italic;">${config.description}</div>` : ''}
                    <div class="chart-canvas">
                        <canvas id="${chartId}"></canvas>
                    </div>
                </div>
            `;

            // Return HTML first, then we'll create the chart after the DOM is updated
            setTimeout(() => {
                const canvas = document.getElementById(chartId);
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                
                if (chartData.chartType === 'bar') {
                    const datasets = chartData.series.map((series, index) => ({
                        label: series.name,
                        data: series.values,
                        backgroundColor: generateChartColors(series.values.length)[index] || '#36A2EB',
                        borderColor: generateChartColors(series.values.length)[index] || '#36A2EB',
                        borderWidth: 1
                    }));

                    // Use chartConfig if available, otherwise use defaults
                    const config = chartData.chartConfig || {};
                    const yAxisConfig = config.yAxis || {};
                    const xAxisConfig = config.xAxis || {};

                    const chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: chartData.xLabels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: yAxisConfig.min !== undefined ? false : true,
                                    min: yAxisConfig.min,
                                    max: yAxisConfig.max,
                                    title: {
                                        display: true,
                                        text: yAxisConfig.title || 'Value'
                                    },
                                    grid: {
                                        display: config.gridLines !== false,
                                        color: getGridColor(),
                                        lineWidth: 1,
                                        drawBorder: true,
                                        drawOnChartArea: true,
                                        drawTicks: true
                                    },
                                    ticks: {
                                        stepSize: yAxisConfig.tickInterval,
                                        maxTicksLimit: yAxisConfig.tickInterval ? undefined : 10,
                                        precision: 2
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: xAxisConfig.title || 'Category'
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: datasets.length > 1
                                }
                            }
                        }
                    });
                    chartInstances.push(chart);
                
                } else if (chartData.chartType === 'pie') {
                    const seriesData = chartData.series[0].values;
                    const labels = seriesData.map(item => item.name);
                    const values = seriesData.map(item => item.value);
                    
                    const chart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: values,
                                backgroundColor: generateChartColors(values.length),
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const total = values.reduce((a, b) => a + b, 0);
                                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    chartInstances.push(chart);
                
                } else if (chartData.chartType === 'scatter') {
                    const config = chartData.chartConfig || {};
                    const xAxisConfig = config.xAxis || {};
                    const yAxisConfig = config.yAxis || {};
                    
                    const chart = new Chart(ctx, {
                        type: 'scatter',
                        data: {
                            datasets: [{
                                label: 'Data Points',
                                data: chartData.points,
                                backgroundColor: getScatterPointColor(),
                                borderColor: getScatterPointColor(),
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'linear',
                                    position: 'bottom',
                                    min: xAxisConfig.min,
                                    max: xAxisConfig.max,
                                    title: {
                                        display: true,
                                        text: xAxisConfig.title || 'X Variable'
                                    },
                                    grid: {
                                        display: config.gridLines !== false,
                                        color: getGridColor()
                                    },
                                    ticks: {
                                        stepSize: xAxisConfig.tickInterval
                                    }
                                },
                                y: {
                                    min: yAxisConfig.min,
                                    max: yAxisConfig.max,
                                    title: {
                                        display: true,
                                        text: yAxisConfig.title || 'Y Variable'
                                    },
                                    grid: {
                                        display: config.gridLines !== false,
                                        color: getGridColor()
                                    },
                                    ticks: {
                                        stepSize: yAxisConfig.tickInterval
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                    chartInstances.push(chart);
                }
            }, 100);

            return chartHtml;
        }

        function renderTable(tableData) {
            if (!tableData || !Array.isArray(tableData) || tableData.length === 0) return '';
            
            const headers = tableData[0];
            const rows = tableData.slice(1);
            
            let tableHtml = '<div class="table-container"><table>';
            
            // Headers
            tableHtml += '<thead><tr>';
            headers.forEach(header => {
                tableHtml += `<th>${header}</th>`;
            });
            tableHtml += '</tr></thead>';
            
            // Rows
            tableHtml += '<tbody>';
            rows.forEach(row => {
                tableHtml += '<tr>';
                row.forEach(cell => {
                    tableHtml += `<td>${cell}</td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table></div>';
            
            return tableHtml;
        }

        function renderChoices(choices) {
            if (!choices || !Array.isArray(choices)) return '';
            
            let choicesHtml = '<div class="choices">';
            choices.forEach(choice => {
                choicesHtml += `
                    <div class="choice">
                        <span class="choice-key">${choice.key}.</span> ${choice.value}
                    </div>
                `;
            });
            choicesHtml += '</div>';
            
            return choicesHtml;
        }

        function renderQuestion(question, index) {
            const questionNumber = index + 1;
            let questionHtml = `
                <div class="quiz-container">
                    <div class="question-header">Question ${questionNumber}</div>
                    <div class="question-id">ID: ${question.id || 'N/A'}</div>
                    <div class="question-id">Type: ${question.type || 'N/A'}</div>
                    
                    <div class="question-prompt">
                        ${question.prompt || 'No prompt provided'}
                    </div>
            `;

            // Handle attachments
            if (question.attachments) {
                // Render chart if present
                if (question.attachments.chartType) {
                    questionHtml += renderChart(question.attachments, question.id);
                }
                
                // Render table if present
                if (question.attachments.table) {
                    questionHtml += renderTable(question.attachments.table);
                }
                
                // Render choices if present (in attachments)
                if (question.attachments.choices) {
                    questionHtml += renderChoices(question.attachments.choices);
                }
            }

            // Handle choices at top level (new format)
            if (question.choices) {
                questionHtml += renderChoices(question.choices);
            }

            // Render answer key if present
            if (question.answerKey) {
                questionHtml += `
                    <div class="answer-key">
                        <strong>Answer:</strong> ${question.answerKey}
                    </div>
                `;
            }

            questionHtml += '</div>';
            return questionHtml;
        }

        function cleanJsonText(text) {
            try {
                // Step 1: Remove all comment lines and empty lines
                const lines = text.split('\n');
                const cleanedLines = lines.filter(line => {
                    const trimmed = line.trim();
                    return !trimmed.startsWith('//') && trimmed !== '';
                });
                
                // Step 2: Join and fix basic JSON issues
                let cleanedText = cleanedLines.join('\n');
                cleanedText = cleanedText.replace(/,(\s*[}\]])/g, '$1'); // Fix trailing commas
                
                // Step 3: Try to parse as-is first (might be valid JSON already)
                try {
                    JSON.parse(cleanedText);
                    return cleanedText; // Already valid JSON
                } catch (e) {
                    // Continue with multi-object processing
                }
                
                // Step 4: Handle multiple JSON objects
                const jsonObjects = [];
                let currentObject = '';
                let braceCount = 0;
                let inString = false;
                let escapeNext = false;
                
                for (let i = 0; i < cleanedText.length; i++) {
                    const char = cleanedText[i];
                    currentObject += char;
                    
                    if (escapeNext) {
                        escapeNext = false;
                        continue;
                    }
                    
                    if (char === '\\') {
                        escapeNext = true;
                        continue;
                    }
                    
                    if (char === '"') {
                        inString = !inString;
                        continue;
                    }
                    
                    if (!inString) {
                        if (char === '{') {
                            braceCount++;
                        } else if (char === '}') {
                            braceCount--;
                            
                            // When braceCount reaches 0, we have a complete object
                            if (braceCount === 0) {
                                const trimmedObject = currentObject.trim();
                                if (trimmedObject) {
                                    // Validate this individual object
                                    try {
                                        JSON.parse(trimmedObject);
                                        jsonObjects.push(trimmedObject);
                                    } catch (e) {
                                        console.warn('Skipping invalid JSON object:', e.message);
                                    }
                                }
                                currentObject = '';
                            }
                        }
                    }
                }
                
                // Handle any remaining content
                if (currentObject.trim()) {
                    try {
                        JSON.parse(currentObject.trim());
                        jsonObjects.push(currentObject.trim());
                    } catch (e) {
                        console.warn('Skipping invalid remaining JSON:', e.message);
                    }
                }
                
                if (jsonObjects.length === 0) {
                    throw new Error('No valid JSON objects found');
                }
                
                // If we have multiple objects, wrap in array
                if (jsonObjects.length > 1) {
                    return '[' + jsonObjects.join(',') + ']';
                } else {
                    return jsonObjects[0];
                }
                
            } catch (error) {
                throw new Error(`JSON sanitization failed: ${error.message}`);
            }
        }

        function renderQuiz(data) {
            try {
                // Store data for dark mode re-rendering
                window.lastLoadedData = data;
                
                // Clear existing charts first
                chartInstances.forEach(chart => chart.destroy());
                chartInstances = [];
                
                let questions = [];
                
                // Handle different JSON structures
                if (Array.isArray(data)) {
                    questions = data;
                } else if (data.questions && Array.isArray(data.questions)) {
                    questions = data.questions;
                } else if (typeof data === 'object') {
                    // Check if it's a single question object
                    if (data.id && data.prompt) {
                        questions = [data];
                    } else {
                        // Try to extract questions from object properties
                        questions = Object.values(data).filter(item => 
                            typeof item === 'object' && item.id && item.prompt
                        );
                    }
                }

                if (questions.length === 0) {
                    showMessage('No valid questions found in the JSON data. Please check the format.');
                    return;
                }

                showStats(questions);
                
                const questionsContainer = document.getElementById('questionsContainer');
                let questionsHtml = '';
                
                questions.forEach((question, index) => {
                    questionsHtml += renderQuestion(question, index);
                });
                
                questionsContainer.innerHTML = questionsHtml;
                showMessage(`Successfully loaded ${questions.length} question(s) with tables and charts! Advanced chart configurations and dark mode support enabled.`, 'success');
                
            } catch (error) {
                showMessage(`Error rendering quiz: ${error.message}`);
            }
        }

        function loadFromFile() {
            const fileInput = document.getElementById('jsonFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('Please select a JSON file first.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const cleanedJson = cleanJsonText(e.target.result);
                    const jsonData = JSON.parse(cleanedJson);
                    renderQuiz(jsonData);
                } catch (error) {
                    showMessage(`Invalid JSON file: ${error.message}`);
                }
            };
            reader.readAsText(file);
        }

        function loadFromText() {
            const jsonInput = document.getElementById('jsonInput');
            const jsonText = jsonInput.value.trim();
            
            if (!jsonText) {
                showMessage('Please paste some JSON data first.');
                return;
            }
            
            try {
                const cleanedJson = cleanJsonText(jsonText);
                const jsonData = JSON.parse(cleanedJson);
                renderQuiz(jsonData);
            } catch (error) {
                showMessage(`Invalid JSON format: ${error.message}`);
            }
        }

        // Dark mode change listener
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                // Re-render all charts when dark mode changes
                const questionsContainer = document.getElementById('questionsContainer');
                if (questionsContainer.innerHTML.trim() !== '') {
                    // If we have loaded questions, re-render them
                    const currentData = window.lastLoadedData;
                    if (currentData) {
                        renderQuiz(currentData);
                    }
                }
            });
        }

        // Load sample data on page load
        window.onload = function() {
            showMessage('Ready to load quiz JSON files! Supports tables, bar/pie/scatter charts with detailed tick intervals, axis ranges, dark mode, and JSON with // comments.', 'success');
        };
    </script>
</body>
</html> 